<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cipher: Piano Melody Encoder</title>
  <style>
    body { font-family: sans-serif; background: #181c29; color: #e0eaff; }
    .main { max-width: 800px; margin: 2em auto; padding: 2em; background: #222842; border-radius: 1em; }
    textarea { width: 100%; min-height: 60px; font-size: 1.1em; }
    .glyphs { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 1em; }
    .glyph-svg { background: #181c29; border-radius: 50%; border: 2px solid #3377ff; width: 48px; height: 48px; }
    .controls { margin: 1em 0; }
    button { background: #3377ff; color: #fff; border: none; border-radius: 5px; padding: 0.5em 1em; margin: 0.5em 0.25em; font-size: 1em; cursor: pointer; }
    button:disabled { background: #444; }
    .label { font-weight: bold; margin-top: 1em; display: block; }
    .outbox { background: #151829; padding: 1em; border-radius: 0.5em; margin-top: 1em; }
    .info { font-size: 0.95em; color: #8aafff; margin-bottom: 1em;}
    .codebox { background: #1a1e33; color: #7ee787; font-family: monospace; font-size: 1.1em; padding: 0.7em; border-radius: 0.4em; margin: 1em 0; }
    .piano { display: flex; align-items: flex-end; margin: 1em 0;}
    .key { width: 32px; height: 150px; border: 1px solid #000; margin: 0 -1px; background: #fff; position: relative; z-index: 1; cursor: pointer; border-radius: 0 0 6px 6px; }
    .key.active, .key:active { background: #88e; }
    .key.black { width: 20px; height: 90px; background: #222; z-index: 2; position: relative; margin-left: -10px; margin-right: -10px; top: 0; border-radius: 0 0 4px 4px; }
    .key.black.active, .key.black:active { background: #f89; }
    .piano-wrapper { overflow-x: auto; }
    .melodybar { margin: 0.5em 0; min-height: 24px; }
    .melodynote { display: inline-block; padding: 2px 6px; margin-right: 2px; background: #333; border-radius: 4px; color: #fff; font-family: monospace; font-size: 1em; }
    .melodynote.playing { background: #7ee787; color: #222842; }
    .melody-controls { margin-bottom: 0.5em; }
  </style>
</head>
<body>
  <div class="main">
    <h1>Cipher: Piano Melody Encoder</h1>
    <div class="info">
      1. Type your message and click "Encode".<br>
      2. Play a melody with your mouse or keyboard (A S D F G H J = white keys, W E T Y U = black keys)<br>
      3. Click "Save Melody to Cipher" and copy the code string.<br>
      4. Paste the code string into the decode area to retrieve both your message and melody!
    </div>
    <span class="label">Text to Encode:</span>
    <textarea id="encodeInput" placeholder="Enter message"></textarea>
    <div class="controls">
      <button id="encodeBtn">Encode</button>
    </div>
    <span class="label">Encoded Code String (copy this):</span>
    <div class="codebox" id="codeStringDisplay" contenteditable="true" spellcheck="false"></div>
    <span class="label">Glyphs:</span>
    <div class="glyphs" id="glyphsDisplay"></div>

    <span class="label">Piano: Play a melody (optional for your cipher!)</span>
    <div class="piano-wrapper"><div class="piano" id="piano"></div></div>
    <div class="melody-controls">
      <button id="clearMelodyBtn">Clear Melody</button>
      <button id="playMelodyBtn">Play Melody</button>
      <button id="saveMelodyBtn">Save Melody to Cipher</button>
    </div>
    <div class="melodybar" id="melodyBar"></div>

    <div class="outbox">
      <span class="label">Paste Encoded Code String to Decode:</span>
      <textarea id="decodeInput" placeholder="Paste code here"></textarea>
      <div class="controls">
        <button id="decodeBtn">Decode</button>
      </div>
      <span class="label">Decoded Text:</span>
      <textarea id="decodedOutput" readonly></textarea>
      <span class="label">Decoded Melody:</span>
      <div class="melodybar" id="decodedMelodyBar"></div>
      <button id="playDecodedMelodyBtn">Play Decoded Melody</button>
    </div>
  </div>
  <script>
  // --- CIPHER ---
  const symbols = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,?! ';
  const symbolToCode = {}, codeToSymbol = {};
  for (let i = 0; i < symbols.length; ++i) {
    const code = i.toString(36);
    symbolToCode[symbols[i]] = code;
    codeToSymbol[code] = symbols[i];
  }
  // 12 color palette for glyphs (Circle of Fifths)
  const palette = [
    "#00eaff", "#00ffb3", "#d7ff00", "#ffe600", "#ff9c00", "#ff3700",
    "#ff00b3", "#7a00ff", "#0039ff", "#00b3ff", "#00ff6a", "#b6ff00"
  ];
  function symbolToFifthsPos(sym) {
    const idx = symbols.indexOf(sym);
    return idx === -1 ? 11 : idx % 12;
  }
  function glyphSVG(pos) {
    const startAngle = (pos / 12) * 2 * Math.PI;
    const endAngle = ((pos + 1) / 12) * 2 * Math.PI;
    const r = 20, cx = 24, cy = 24;
    const x1 = cx + r * Math.cos(startAngle);
    const y1 = cy + r * Math.sin(startAngle);
    const x2 = cx + r * Math.cos(endAngle);
    const y2 = cy + r * Math.sin(endAngle);
    const largeArc = 0;
    const path = `M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${largeArc},1 ${x2},${y2} Z`;
    const color = palette[pos];
    return `<svg class="glyph-svg" data-pos="${pos}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path d="${path}" fill="${color}" stroke="#fff" stroke-width="2"/><circle cx="${cx}" cy="${cy}" r="4" fill="#222842"/></svg>`;
  }
  // Code string: text and melody separated by "!"
  function encodeText(text) {
    text = text.toUpperCase();
    let code = '';
    for (let c of text) {
      let v = symbolToCode[c];
      if (!v) v = symbolToCode[' '];
      code += v;
    }
    return code;
  }
  function decodeString(str) {
    let result = '';
    for (let ch of str) {
      let c = codeToSymbol[ch];
      if (!c) c = '?';
      result += c;
    }
    return result;
  }
  // --- PIANO ---
  // Notes: C4 to B5 (2 octaves, MIDI 60..83)
  const pianoKeys = [
    {note:60, label:'C4', key:'A'}, {note:61, isBlack:true, key:'W'},
    {note:62, label:'D4', key:'S'}, {note:63, isBlack:true, key:'E'},
    {note:64, label:'E4', key:'D'},
    {note:65, label:'F4', key:'F'}, {note:66, isBlack:true, key:'T'},
    {note:67, label:'G4', key:'G'}, {note:68, isBlack:true, key:'Y'},
    {note:69, label:'A4', key:'H'}, {note:70, isBlack:true, key:'U'},
    {note:71, label:'B4', key:'J'},
    // Octave up
    {note:72, label:'C5', key:'K'}, {note:73, isBlack:true, key:'O'},
    {note:74, label:'D5', key:'L'}, {note:75, isBlack:true, key:'P'},
    {note:76, label:'E5', key:';'},
    {note:77, label:'F5'}, {note:78, isBlack:true},
    {note:79, label:'G5'}, {note:80, isBlack:true},
    {note:81, label:'A5'}, {note:82, isBlack:true},
    {note:83, label:'B5'}
  ];
  // White/black key order for rendering
  const piano = document.getElementById('piano');
  function renderPiano() {
    piano.innerHTML = '';
    pianoKeys.forEach((k, i) => {
      const div = document.createElement('div');
      div.className = 'key' + (k.isBlack ? ' black' : '');
      div.dataset.note = k.note;
      if (k.label) div.innerHTML = k.label + (k.key ? `<br><span style="font-size:0.85em">${k.key}</span>` : '');
      div.onmousedown = e => playPianoNote(k.note, true);
      div.onmouseup = e => div.classList.remove('active');
      div.onmouseleave = e => div.classList.remove('active');
      piano.appendChild(div);
    });
  }
  renderPiano();

  // Play MIDI note (60 = C4)
  function playPianoNote(note, visual) {
    const freq = 440 * Math.pow(2, (note-69)/12);
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    o.type = 'sawtooth';
    o.frequency.value = freq;
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.18, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.22);
    o.connect(g).connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.22);
    o.onended = ()=>ctx.close();
    // Visual highlight
    if (visual) {
      document.querySelectorAll('.key').forEach(e=>e.classList.remove('active'));
      const k = document.querySelector(`.key[data-note="${note}"]`);
      if (k) { k.classList.add('active'); setTimeout(()=>k.classList.remove('active'),180);}
    }
  }

  // Keyboard controls
  document.addEventListener('keydown', e => {
    if (e.repeat) return;
    const key = e.key.toUpperCase();
    const match = pianoKeys.find(k => k.key && k.key.toUpperCase() === key);
    if (match) playPianoNote(match.note, true), addToMelody(match.note);
  });

  // Melody recording
  let melody = [];
  function addToMelody(note) {
    if (melody.length >= 32) return;
    melody.push(note);
    updateMelodyBar();
  }
  function updateMelodyBar() {
    const bar = document.getElementById('melodyBar');
    bar.innerHTML = '';
    melody.forEach((n,i) => {
      const span = document.createElement('span');
      span.className = 'melodynote';
      span.textContent = midiToNoteName(n);
      bar.appendChild(span);
    });
  }
  function midiToNoteName(midi) {
    const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    return names[midi%12] + Math.floor(midi/12-1);
  }
  // Mouse clicks on piano
  piano.addEventListener('mousedown', function(e) {
    if (e.target.classList.contains('key')) {
      const note = parseInt(e.target.dataset.note,10);
      playPianoNote(note,true);
      addToMelody(note);
    }
  });
  // Buttons
  document.getElementById('clearMelodyBtn').onclick = ()=>{melody=[];updateMelodyBar();};
  document.getElementById('playMelodyBtn').onclick = ()=>playMelody(melody);

  function playMelody(mel) {
    if (!mel || !mel.length) return;
    let i=0;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const bar = document.getElementById('melodyBar');
    function playNext() {
      if (i>=mel.length) {ctx.close(); bar.querySelectorAll('.melodynote').forEach(s=>s.classList.remove('playing')); return;}
      const midi = mel[i];
      playMidiNote(ctx, midi);
      // Visual highlight
      const spans = bar.querySelectorAll('.melodynote');
      spans.forEach(s=>s.classList.remove('playing'));
      if (spans[i]) spans[i].classList.add('playing');
      i++;
      setTimeout(playNext, 220);
    }
    playNext();
  }
  function playMidiNote(ctx, midi) {
    const freq = 440 * Math.pow(2, (midi-69)/12);
    const o = ctx.createOscillator();
    o.type = 'sawtooth';
    o.frequency.value = freq;
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.17, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.18);
    o.connect(g).connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.19);
  }

  // Save melody to cipher code (as base36 MIDI numbers, separated by "-")
  document.getElementById('saveMelodyBtn').onclick = () => {
    const text = encodeInput.value.trim();
    if (!text) return;
    const code = encodeText(text);
    // Melody as base36-encoded MIDI numbers, separated by -
    const melodyStr = melody.map(x=>x.toString(36)).join('-');
    codeStringDisplay.textContent = code + '!' + melodyStr;
  };

  // Show glyphs and code
  function showGlyphsAndCode(text) {
    const code = encodeText(text);
    codeStringDisplay.textContent = code;
    glyphsDisplay.innerHTML = '';
    for(let c of text.toUpperCase()) {
      let pos = symbolToFifthsPos(c);
      glyphsDisplay.innerHTML += glyphSVG(pos);
    }
  }
  // Encode button
  encodeBtn.onclick = () => {
    const text = encodeInput.value.trim();
    if (!text) return;
    showGlyphsAndCode(text);
  };

  // --- Decode section ---
  document.getElementById('decodeBtn').onclick = () => {
    // Split code string into text and melody
    const val = decodeInput.value.trim();
    let [code, melodyStr] = val.split('!');
    if (!code) return;
    const text = decodeString(code);
    decodedOutput.value = text;
    showGlyphsAndCode(text);

    let notes = [];
    if (melodyStr) {
      notes = melodyStr.split('-').map(x=>parseInt(x,36)).filter(x=>!isNaN(x));
    }
    showDecodedMelody(notes);
    window._decodedMelody = notes;
  };

  function showDecodedMelody(notes) {
    const bar = document.getElementById('decodedMelodyBar');
    bar.innerHTML = '';
    notes.forEach((n,i) => {
      const span = document.createElement('span');
      span.className = 'melodynote';
      span.textContent = midiToNoteName(n);
      bar.appendChild(span);
    });
  }
  document.getElementById('playDecodedMelodyBtn').onclick = () => {
    if(!window._decodedMelody || !window._decodedMelody.length) return;
    playDecodedMelody(window._decodedMelody);
  };
  function playDecodedMelody(mel) {
    if (!mel || !mel.length) return;
    let i=0;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const bar = document.getElementById('decodedMelodyBar');
    function playNext() {
      if (i>=mel.length) {ctx.close(); bar.querySelectorAll('.melodynote').forEach(s=>s.classList.remove('playing')); return;}
      const midi = mel[i];
      playMidiNote(ctx, midi);
      // Visual highlight
      const spans = bar.querySelectorAll('.melodynote');
      spans.forEach(s=>s.classList.remove('playing'));
      if (spans[i]) spans[i].classList.add('playing');
      i++;
      setTimeout(playNext, 220);
    }
    playNext();
  }

  // Prefill demo
  encodeInput.value = "TRON CIPHER";
  showGlyphsAndCode(encodeInput.value);

  </script>
</body>
</html>
