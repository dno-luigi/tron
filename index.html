<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cipher: Piano Melody Password (Export/Import)</title>
  <style>
    body { font-family: sans-serif; background: #181c29; color: #e0eaff; }
    .main { max-width: 800px; margin: 2em auto; padding: 2em; background: #222842; border-radius: 1em; }
    textarea { width: 100%; min-height: 60px; font-size: 1.1em; }
    .glyphs { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 1em; }
    .glyph-svg { background: #181c29; border-radius: 50%; border: 2px solid #3377ff; width: 48px; height: 48px; }
    .controls { margin: 1em 0; }
    button { background: #3377ff; color: #fff; border: none; border-radius: 5px; padding: 0.5em 1em; margin: 0.5em 0.25em; font-size: 1em; cursor: pointer; }
    button:disabled { background: #444; }
    .label { font-weight: bold; margin-top: 1em; display: block; }
    .outbox { background: #151829; padding: 1em; border-radius: 0.5em; margin-top: 1em; }
    .info { font-size: 0.95em; color: #8aafff; margin-bottom: 1em;}
    .codebox { background: #1a1e33; color: #7ee787; font-family: monospace; font-size: 1.1em; padding: 0.7em; border-radius: 0.4em; margin: 1em 0; }
    .piano-container { position: relative; width: 735px; margin: 1em 0; }
    .piano { display: flex; position: relative; z-index: 1; }
    .white-key {
      width: 42px; height: 180px; border: 1px solid #222; background: #fff; margin-right: -1px;
      border-radius: 0 0 6px 6px; position: relative; z-index: 1; display: flex; align-items: flex-end; justify-content: center; font-size: 0.95em;
      cursor: pointer; box-sizing: border-box;
    }
    .white-key.active { background: #7ee787; }
    .black-key {
      width: 30px; height: 110px; background: #222; position: absolute; z-index: 2; top: 0;
      margin-left: -15px; border-radius: 0 0 4px 4px; display: flex; align-items: flex-end; justify-content: center; font-size: 0.8em;
      color: #fff; cursor: pointer; box-sizing: border-box;
    }
    .black-key.active { background: #f89; }
    .melodybar { margin: 0.5em 0; min-height: 24px; }
    .melodynote { display: inline-block; padding: 2px 6px; margin-right: 2px; background: #333; border-radius: 4px; color: #fff; font-family: monospace; font-size: 1em; }
    .melodynote.playing { background: #7ee787; color: #222842; }
    .melody-controls { margin-bottom: 0.5em; }
    .success { color: #7ee787; font-weight: bold; margin-top: 1em; }
    .fail { color: #ff3700; font-weight: bold; margin-top: 1em; }
    .export-box { background: #1a1e33; color: #ffe600; font-family: monospace; font-size: 1em; padding: 0.5em; border-radius: 0.4em; margin: 0.5em 0; cursor: pointer; }
    .import-group { margin: 0.8em 0; }
    input[type="text"].import { width: 290px; font-size: 1em; }
    .hash-flex { display: flex; align-items: center; gap: 0.5em; margin-top: 0.5em;}
    #copyHashBtn { background: #7ee787; color: #222; font-size: 0.95em; padding: 0.2em 0.7em; }
    #copyHashBtn:hover { background: #ffe600; }
    .hash-label { font-size: 0.99em; color: #ffe600; }
  </style>
</head>
<body>
  <div class="main">
    <h1>Cipher: Piano Melody Password (Export/Import)</h1>
    <div class="info">
      1. <b>Encode:</b> Type your message, click "Encode", play a melody (your password), then click "Save Melody as Password".<br>
      2. <b>Export/Save Melody:</b> Click "Export Melody Pattern" to share with friends (they can import it to unlock).<br>
      3. <b>Decode:</b> Paste the code string, play the correct melody or import the pattern, and click "Decode". Only the right melody will reveal the message!<br>
      <b>Melody is hashed for privacy, but you can share the pattern string for non-musicians.</b>
    </div>
    <span class="label">Text to Encode:</span>
    <textarea id="encodeInput" placeholder="Enter message"></textarea>
    <div class="controls">
      <button id="encodeBtn">Encode</button>
    </div>
    <span class="label">Encoded Code String (copy this):</span>
    <div class="codebox" id="codeStringDisplay" contenteditable="true" spellcheck="false"></div>
    <span class="label">Glyphs:</span>
    <div class="glyphs" id="glyphsDisplay"></div>

    <span class="label">Piano: Play a melody (your password!)</span>
    <div class="piano-container">
      <div class="piano" id="piano"></div>
    </div>
    <div class="melody-controls">
      <button id="clearMelodyBtn">Clear Melody</button>
      <button id="playMelodyBtn">Play Melody</button>
      <button id="saveMelodyBtn">Save Melody as Password</button>
      <button id="exportMelodyBtn">Export Melody Pattern</button>
    </div>
    <div class="melodybar" id="melodyBar"></div>
    <div class="hash-flex" id="hashFlex" style="display:none;">
      <span class="hash-label">Password hash:</span>
      <span id="fullHash" style="font-family:monospace;font-size:0.97em;word-break:break-all;"></span>
      <button id="copyHashBtn" title="Copy hash">Copy</button>
      <span id="hashNote" style="color:#7ee787;font-size:0.92em;"></span>
    </div>
    <div id="exportBox" class="export-box" style="display:none;" title="Click to copy"></div>

    <div class="outbox">
      <span class="label">Paste Encoded Code String to Decode:</span>
      <textarea id="decodeInput" placeholder="Paste code here"></textarea>
      <span class="label">Piano: Play the correct melody (password) to unlock:</span>
      <div class="piano-container">
        <div class="piano" id="piano2"></div>
      </div>
      <div class="melody-controls">
        <button id="clearMelodyBtn2">Clear Melody</button>
        <button id="playMelodyBtn2">Play Melody</button>
        <button id="decodeBtn">Decode</button>
      </div>
      <div class="melodybar" id="melodyBar2"></div>
      <div class="import-group">
        <b>Or, import a melody pattern:&nbsp;</b>
        <input type="text" class="import" id="importMelodyInput" placeholder="Paste melody pattern here">
        <button id="importMelodyBtn">Import</button>
      </div>
      <div id="decodeStatus"></div>
      <span class="label">Decoded Text:</span>
      <textarea id="decodedOutput" readonly></textarea>
    </div>
  </div>
  <script>
  // --- CIPHER ---
  const symbols = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,?! ';
  const symbolToCode = {}, codeToSymbol = {};
  for (let i = 0; i < symbols.length; ++i) {
    const code = i.toString(36);
    symbolToCode[symbols[i]] = code;
    codeToSymbol[code] = symbols[i];
  }
  const palette = [
    "#00eaff", "#00ffb3", "#d7ff00", "#ffe600", "#ff9c00", "#ff3700",
    "#ff00b3", "#7a00ff", "#0039ff", "#00b3ff", "#00ff6a", "#b6ff00"
  ];
  function symbolToFifthsPos(sym) {
    const idx = symbols.indexOf(sym);
    return idx === -1 ? 11 : idx % 12;
  }
  function glyphSVG(pos) {
    const startAngle = (pos / 12) * 2 * Math.PI;
    const endAngle = ((pos + 1) / 12) * 2 * Math.PI;
    const r = 20, cx = 24, cy = 24;
    const x1 = cx + r * Math.cos(startAngle);
    const y1 = cy + r * Math.sin(startAngle);
    const x2 = cx + r * Math.cos(endAngle);
    const y2 = cy + r * Math.sin(endAngle);
    const largeArc = 0;
    const path = `M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${largeArc},1 ${x2},${y2} Z`;
    const color = palette[pos];
    return `<svg class="glyph-svg" data-pos="${pos}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path d="${path}" fill="${color}" stroke="#fff" stroke-width="2"/><circle cx="${cx}" cy="${cy}" r="4" fill="#222842"/></svg>`;
  }
  function encodeText(text) {
    text = text.toUpperCase();
    let code = '';
    for (let c of text) {
      let v = symbolToCode[c];
      if (!v) v = symbolToCode[' '];
      code += v;
    }
    return code;
  }
  function decodeString(str) {
    let result = '';
    for (let ch of str) {
      let c = codeToSymbol[ch];
      if (!c) c = '?';
      result += c;
    }
    return result;
  }
  // --- PIANO ---
  const pianoWhite = [
    {m:60,l:'C4',k:'A'},{m:62,l:'D4',k:'S'},{m:64,l:'E4',k:'D'},
    {m:65,l:'F4',k:'F'},{m:67,l:'G4',k:'G'},{m:69,l:'A4',k:'H'},{m:71,l:'B4',k:'J'},
    {m:72,l:'C5',k:'K'},{m:74,l:'D5',k:'L'},{m:76,l:'E5',k:';'},
    {m:77,l:'F5'},{m:79,l:'G5'},{m:81,l:'A5'},{m:83,l:'B5'}
  ];
  const pianoBlack = [
    {m:61,l:'C#4',k:'W',pos:0},{m:63,l:'D#4',k:'E',pos:1},
    {m:66,l:'F#4',k:'T',pos:3},{m:68,l:'G#4',k:'Y',pos:4},{m:70,l:'A#4',k:'U',pos:5},
    {m:73,l:'C#5',k:'O',pos:7},{m:75,l:'D#5',k:'P',pos:8},
    {m:78,l:'F#5',pos:10},{m:80,l:'G#5',pos:11},{m:82,l:'A#5',pos:12}
  ];
  function renderPiano(pianoId, melodyCb) {
    const piano = document.getElementById(pianoId);
    piano.innerHTML = '';
    pianoWhite.forEach((k,i)=>{
      const div = document.createElement('div');
      div.className = 'white-key';
      div.dataset.note = k.m;
      div.innerHTML = `<span>${k.l}</span><br><span style="font-size:0.8em">${k.k?k.k:''}</span>`;
      div.onmousedown = e => { playPianoNote(k.m, true, pianoId); if (melodyCb) melodyCb(k.m);}
      div.onmouseup = div.onmouseleave = e=>div.classList.remove('active');
      piano.appendChild(div);
    });
    pianoBlack.forEach(k=>{
      const leftKey = Math.floor((k.m-60)/2)+((k.m-60)%2);
      const parent = piano.children[leftKey];
      const div = document.createElement('div');
      div.className = 'black-key';
      div.style.left = (leftKey*42+29)+'px';
      div.dataset.note = k.m;
      div.innerHTML = `<span>${k.l}</span><br><span style="font-size:0.7em">${k.k?k.k:''}</span>`;
      div.onmousedown = e => { playPianoNote(k.m, true, pianoId); if (melodyCb) melodyCb(k.m);}
      div.onmouseup = div.onmouseleave = e=>div.classList.remove('active');
      parent.parentNode.insertBefore(div, parent.nextSibling);
    });
  }

  function playPianoNote(note, visual, pianoId) {
    const freq = 440 * Math.pow(2, (note-69)/12);
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    o.type = 'sawtooth';
    o.frequency.value = freq;
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.18, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.22);
    o.connect(g).connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.22);
    o.onended = ()=>ctx.close();
    if (visual) {
      let sel = '.white-key,.black-key';
      if (pianoId) sel = `#${pianoId} .white-key,#${pianoId} .black-key`;
      document.querySelectorAll(sel).forEach(e=>e.classList.remove('active'));
      const k = document.querySelector(`${pianoId ? '#'+pianoId+' ' : ''}.white-key[data-note="${note}"],${pianoId ? '#'+pianoId+' ' : ''}.black-key[data-note="${note}"]`);
      if (k) { k.classList.add('active'); setTimeout(()=>k.classList.remove('active'),180);}
    }
  }
  // Melody recording for ENCODE
  let melody = [];
  function addToMelody(note) {
    if (melody.length >= 32) return;
    melody.push(note);
    updateMelodyBar();
  }
  function updateMelodyBar() {
    const bar = document.getElementById('melodyBar');
    bar.innerHTML = '';
    melody.forEach((n,i) => {
      const span = document.createElement('span');
      span.className = 'melodynote';
      span.textContent = midiToNoteName(n);
      bar.appendChild(span);
    });
  }
  function midiToNoteName(midi) {
    const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    return names[midi%12] + Math.floor(midi/12-1);
  }
  document.getElementById('clearMelodyBtn').onclick = ()=>{
    melody=[];
    updateMelodyBar();
    document.getElementById('hashFlex').style.display = 'none';
    document.getElementById('exportBox').style.display = 'none';
  };
  document.getElementById('playMelodyBtn').onclick = ()=>playMelody(melody);

  function playMelody(mel) {
    if (!mel || !mel.length) return;
    let i=0;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const bar = document.getElementById('melodyBar');
    function playNext() {
      if (i>=mel.length) {ctx.close(); bar.querySelectorAll('.melodynote').forEach(s=>s.classList.remove('playing')); return;}
      const midi = mel[i];
      playMidiNote(ctx, midi);
      const spans = bar.querySelectorAll('.melodynote');
      spans.forEach(s=>s.classList.remove('playing'));
      if (spans[i]) spans[i].classList.add('playing');
      i++;
      setTimeout(playNext, 220);
    }
    playNext();
  }
  function playMidiNote(ctx, midi) {
    const freq = 440 * Math.pow(2, (midi-69)/12);
    const o = ctx.createOscillator();
    o.type = 'sawtooth';
    o.frequency.value = freq;
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.17, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.18);
    o.connect(g).connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.19);
  }

  // Melody hash helpers
  async function hashMelody(mel) {
    const bytes = new Uint8Array(mel);
    const hashBuf = await window.crypto.subtle.digest('SHA-256', bytes);
    return Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  let passwordHash = '';
  document.getElementById('saveMelodyBtn').onclick = async () => {
    if (!melody.length) { alert('Play a melody as your password!'); return; }
    passwordHash = await hashMelody(melody);
    document.getElementById('fullHash').textContent = passwordHash;
    document.getElementById('hashFlex').style.display = 'flex';
    document.getElementById('hashNote').textContent = "(64 chars SHA-256, copy this for admin unlock)";
  };
  document.getElementById('copyHashBtn').onclick = () => {
    const hash = document.getElementById('fullHash').textContent;
    if (hash.length > 0) {
      navigator.clipboard.writeText(hash).then(()=>{ 
        document.getElementById('hashNote').textContent = "Copied!";
        setTimeout(()=>{ document.getElementById('hashNote').textContent = "(64 chars SHA-256, copy this for admin unlock)" },1200);
      });
    }
  };

  // Export melody as pattern string
  function melodyToPattern(mel) {
    // Use base36 for compactness
    return mel.map(n=>n.toString(36)).join('-');
  }
  function patternToMelody(str) {
    return str.split('-').map(s=>parseInt(s,36)).filter(x=>!isNaN(x));
  }
  document.getElementById('exportMelodyBtn').onclick = ()=>{
    if (!melody.length) { alert('No melody to export!'); return; }
    const pat = melodyToPattern(melody);
    document.getElementById('exportBox').textContent = pat;
    document.getElementById('exportBox').style.display = '';
    document.getElementById('exportBox').onclick = function() {
      navigator.clipboard.writeText(pat);
      document.getElementById('exportBox').textContent = 'Copied!';
      setTimeout(()=>document.getElementById('exportBox').textContent=pat,1200);
    }
  };

  // Show glyphs and code
  function showGlyphsAndCode(text) {
    const code = encodeText(text);
    codeStringDisplay.textContent = code;
    glyphsDisplay.innerHTML = '';
    for(let c of text.toUpperCase()) {
      let pos = symbolToFifthsPos(c);
      glyphsDisplay.innerHTML += glyphSVG(pos);
    }
  }
  encodeBtn.onclick = () => {
    const text = encodeInput.value.trim();
    if (!text) return;
    showGlyphsAndCode(text);
  };

  // PIANO for DECODE
  let melody2 = [];
  function addToMelody2(note) {
    if (melody2.length >= 32) return;
    melody2.push(note);
    updateMelodyBar2();
  }
  function updateMelodyBar2() {
    const bar = document.getElementById('melodyBar2');
    bar.innerHTML = '';
    melody2.forEach((n,i) => {
      const span = document.createElement('span');
      span.className = 'melodynote';
      span.textContent = midiToNoteName(n);
      bar.appendChild(span);
    });
  }
  document.getElementById('clearMelodyBtn2').onclick = ()=>{
    melody2=[];
    updateMelodyBar2();
    document.getElementById('importMelodyInput').value = '';
  };
  document.getElementById('playMelodyBtn2').onclick = ()=>playMelody2(melody2);

  function playMelody2(mel) {
    if (!mel || !mel.length) return;
    let i=0;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const bar = document.getElementById('melodyBar2');
    function playNext() {
      if (i>=mel.length) {ctx.close(); bar.querySelectorAll('.melodynote').forEach(s=>s.classList.remove('playing')); return;}
      const midi = mel[i];
      playMidiNote(ctx, midi);
      const spans = bar.querySelectorAll('.melodynote');
      spans.forEach(s=>s.classList.remove('playing'));
      if (spans[i]) spans[i].classList.add('playing');
      i++;
      setTimeout(playNext, 220);
    }
    playNext();
  }

  // Import melody pattern for decode
  document.getElementById('importMelodyBtn').onclick = ()=>{
    const pat = document.getElementById('importMelodyInput').value.trim();
    if (!pat) return;
    melody2 = patternToMelody(pat);
    updateMelodyBar2();
  };

  // Render both pianos
  renderPiano('piano', addToMelody);
  renderPiano('piano2', addToMelody2);

  // Keyboard controls
  document.addEventListener('keydown', e => {
    if (e.repeat) return;
    const key = e.key.toUpperCase();
    let match = pianoWhite.find(k => k.k && k.k.toUpperCase() === key);
    if (!match) match = pianoBlack.find(k => k.k && k.k.toUpperCase() === key);
    if (document.activeElement === document.getElementById('decodeInput') || document.activeElement === document.body || document.activeElement === document.getElementById('importMelodyInput')) {
      if (match) playPianoNote(match.m, true, 'piano2'), addToMelody2(match.m);
    } else {
      if (match) playPianoNote(match.m, true, 'piano'), addToMelody(match.m);
    }
  });

  // --- Decode section ---
  document.getElementById('decodeBtn').onclick = async () => {
    const code = decodeInput.value.trim();
    const text = decodeString(code);
    const status = document.getElementById('decodeStatus');
    if (!passwordHash.length) {
      status.textContent = '';
      decodedOutput.value = '';
      alert('You must save a melody as password during encoding, and play or import the same melody here to decode.');
      return;
    }
    const hash2 = await hashMelody(melody2);
    if (hash2 === passwordHash) {
      status.innerHTML = '<span class="success">Password accepted!</span>';
      decodedOutput.value = text;
    } else {
      status.innerHTML = '<span class="fail">Incorrect melody!</span>';
      decodedOutput.value = '';
    }
  };

  encodeInput.value = "TRON MELODY LOCK";
  showGlyphsAndCode(encodeInput.value);

  </script>
</body>
</html>
